# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Quick Start

```bash
make devrun             # Start Panda watcher + Next.js dev server (localhost:3000)
make lint               # TypeScript + ESLint checks
make pretty             # Auto-fix code formatting
npm run build           # Production build (generates Panda + optimizes)
make help               # Show all available make targets
```

**Essential First Read:** `/docs/specs/specification_stack_and_tools.md` - Contains all project requirements and decisions.

## Project Overview

**SocioSim** is a sociology interview simulator helping social sciences students practice qualitative interviews with AI-powered avatars. Currently in MVP authentication phase; only registration/login is implemented.

**Stack:** Next.js 16 + React 19 + TypeScript + Chakra UI v3 + Panda CSS + Supabase PostgreSQL

**Language:** French (UI text, error messages, variable names when appropriate)

## Code Structure

```
src/app/
├── api/                           # API route handlers
│   ├── register/route.ts          # User registration endpoint
│   └── register/set-password/     # Password setup from token
├── register/                      # Registration UI pages
│   ├── confirmation/              # Email confirmation page
│   └── set-password/              # Password setup form
├── login/                         # Login page
├── components/                    # Reusable React components
├── layout.tsx                     # Root layout (global setup)
├── providers.tsx                  # Chakra UI provider wrapper
├── page.tsx                       # Home page
└── globals.css                    # Global styles

src/lib/
├── supabaseClient.ts              # Browser client (public anon key)
└── supabaseServiceClient.ts       # Server client (service role key)

supabase/
├── migrations/                    # SQL migration scripts
├── seed.sql                       # Development seed data
└── config.toml                    # Local Supabase config

styled-system/                     # AUTO-GENERATED by Panda CSS
└── (DO NOT edit manually)

docs/specs/                        # Technical specifications (source of truth)
docs/chakra-v3/                    # Chakra UI v3 migration notes
```

## Development Workflow

### Starting Development
1. `npm install` (if dependencies not installed)
2. `make devrun` - Runs Panda CSS watcher + Next.js dev server simultaneously
3. Open `http://localhost:3000`
4. Changes auto-reload via HMR

### Before Committing
```bash
make lint              # Check types + linting
make pretty            # Auto-fix formatting
```

Commits should be lowercase, imperative: `"add interview lobby screen"`, `"fix password validation"`

Default branch is **`main`**.

### Adding New Features
1. Create page/component in `src/app/`
2. Run `make devrun` - Panda watches for new CSS usage
3. Import Chakra components from `@chakra-ui/react`
4. No manual Panda config needed; codegen is automatic

## Key Technology Details

### Next.js App Router
- File-based routing under `src/app/`
- `page.tsx` creates routes; `layout.tsx` wraps them
- API routes in `/app/api/` directory
- Import aliases: `@/*` maps to `src/*` (allows clean imports from `@/app/`, `@/lib/`, etc.)

### Chakra UI v3 (Not v2!) ⚠️
**IMPORTANT:** This project uses Chakra UI v3 ONLY. v2 components/patterns will cause TypeScript errors.

**Common v2 → v3 Breaking Changes:**

| v2 (❌ Don't Use) | v3 (✅ Use This) | Example |
|---|---|---|
| `InputRightElement` | `endElement` prop | `<InputGroup endElement={<Icon />}>` |
| `colorScheme` prop | `colorPalette` prop | `colorPalette="blue"` |
| `spacing` prop | `gap`/`columnGap`/`rowGap` | `gap={4}` |
| `isDisabled` | `disabled` | `disabled={true}` |
| `isFocusable` | `focusable` | `focusable={true}` |
| Nested component structure | Direct props | Use `endElement` instead of wrapper |

**Real Error Example:**
```
// ❌ v2 PATTERN (WRONG - TypeScript Error)
import { InputRightElement } from "@chakra-ui/react";
<InputGroup>
  <Input />
  <InputRightElement>
    <Icon />
  </InputRightElement>
</InputGroup>

// ✅ v3 PATTERN (CORRECT)
<InputGroup endElement={<Icon />}>
  <Input />
</InputGroup>
```

**Before Using a Component:**
1. Check `/docs/chakra-v3/` for migration notes
2. Verify exports in `@chakra-ui/react` exist
3. If TypeScript complains about missing exports (e.g., "has no exported member"), the component is v2-only
4. Run `make lint` to catch these errors before pushing

**Reference:** `/docs/chakra-v3/` contains complete v3 API documentation

### Panda CSS
- Type-safe CSS-in-JS with Zero-Runtime
- Generates tokens to `styled-system/` (auto-generated, never edit)
- Scans `src/app/**/*.{ts,tsx}` for CSS usage
- `make devrun` - Runs Panda watch mode in parallel with Next.js dev server
- Panda codegen is automatically included in `npm run build` for production

### TypeScript
- Strict mode enabled (`compilerOptions.strict: true`)
- Target: ES2017
- Path aliases for clean imports

### Supabase
- **Browser client** (`src/lib/supabaseClient.ts`): Uses public anon key, accessible from client
- **Server client** (`src/lib/supabaseServiceClient.ts`): Uses service role key, server-only
- Environment variables in `.env.local` (never commit):
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY` (server-only, never expose)

### Database
Current tables: `users` (with role-based RBAC)

Planned tables: `avatars`, `interviews`, `messages`, `feedback_threads`, `llm_calls`, `feature_flags`

All tables use Row-Level Security (RLS) for data isolation by role.

## Coding Standards

### File Naming
- **Routes/pages:** lowercase with dashes (`register/set-password/`)
- **Components:** PascalCase (`Header.tsx`, `LoginForm.tsx`)
- **Utilities:** camelCase (`supabaseClient.ts`)

### Component Style
- Functional components with React 19 hooks
- 2-space indentation
- Double quotes for strings
- Colocate styles with components (CSS Modules or Panda CSS inline)

### Input Components - Global Padding
**Input padding is applied globally in `globals.css`** - no per-component props needed.

All input fields automatically receive:
- Horizontal padding: `0.75rem` (left/right)
- Vertical padding: `0.5rem` (top/bottom)

This covers:
- Text inputs (`type="text"`)
- Email inputs (`type="email"`)
- Password inputs (`type="password"`)
- Textareas
- Select dropdowns
- Other standard input types

**No need to add `px` or `py` props to individual Input components** - it's handled by global CSS in `src/app/globals.css`.

### Imports
```typescript
// Chakra UI components
import { Box, Flex, Button } from "@chakra-ui/react";

// Project utilities
import { supabaseClient } from "@/lib/supabaseClient";

// Path alias usage (not relative imports)
import Header from "@/components/Header";
```

### API Routes
- Use `supabaseServiceClient` for database access (has admin privileges)
- Validate input; return error details in JSON
- Examples in `src/app/api/register/route.ts` and `set-password/route.ts`

## Common Tasks

### Create a New Page
```typescript
// src/app/new-feature/page.tsx
import { Box, Heading } from "@chakra-ui/react";

export default function NewFeaturePage() {
  return (
    <Box p={8}>
      <Heading>New Feature</Heading>
    </Box>
  );
}
```

### Create an API Route
```typescript
// src/app/api/new-route/route.ts
import { NextRequest, NextResponse } from "next/server";
import { supabaseServiceClient } from "@/lib/supabaseServiceClient";

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    // Your logic here
    return NextResponse.json({ success: true });
  } catch (error) {
    return NextResponse.json(
      { error: "Invalid request" },
      { status: 400 }
    );
  }
}
```

### Add a Chakra Component
1. Import from `@chakra-ui/react`
2. Use in your JSX
3. Panda CSS auto-generates styles (no manual setup needed)
```typescript
import { Button, colorPalette } from "@chakra-ui/react";

<Button colorPalette="teal" size="lg">Click me</Button>
```

### Access Database from API Route
Use `supabaseServiceClient` (server-side only, has admin privileges):
```typescript
import { supabaseServiceClient } from "@/lib/supabaseServiceClient";

const { data, error } = await supabaseServiceClient
  .from("users")
  .select("*")
  .eq("email", email);
```

### Access Database from Component
Use `supabaseClient` (browser client, respects RLS):
```typescript
import { supabaseClient } from "@/lib/supabaseClient";

const { data } = await supabaseClient
  .from("interviews")
  .select("*");
```

## Configuration Files

### Makefile Commands
- `make devrun` - Panda watch + Next.js dev server
- `make lint` - ESLint and TypeScript type checking
- `make pretty` - Prettier auto-fix

### package.json (underlying npm scripts)
- `npm run dev` - Panda watch + Next.js dev (aliased by `make devrun`)
- `npm run build` - Panda codegen + Next.js build
- `npm run lint:all` - ESLint + TypeScript check (aliased by `make lint`)
- `npm run format:fix` - Prettier auto-fix (aliased by `make pretty`)

### tsconfig.json
- Strict mode enabled
- Path alias: `@/*` → `src/*` (enables `@/app/`, `@/lib/`, etc. imports)
- Target: ES2017

### next.config.ts
- Minimal config (Turbopack pinned to project root)

### panda.config.ts
- Scans `src/app/**/*.{ts,tsx}` for styles
- Outputs to `styled-system/` (auto-generated)
- Preflight CSS reset enabled

### eslint.config.mjs
- Next.js recommended rules
- Ignores generated files and build directories

## CI/CD & Node Version

### Node Version
The project uses **Node.js 20.11.0** (LTS) configured in `.nvmrc`. When using `nvm`:
```bash
nvm use  # Automatically switches to v20.11.0
```

The CI/CD pipelines automatically read from `.nvmrc` to ensure consistency.

### GitHub Actions Workflows

#### `ci.yml` - Pull Request Checks
Runs on all pull requests to verify code quality:
```yaml
- Install dependencies
- Run lint:all (ESLint + TypeScript)
- Run build (Panda codegen + Next.js build)
```

Checks must pass before merging to `main`.

#### `create-pr.yml` - Auto Create PR
Automatically creates a pull request when pushing to any branch (except `main`):
```yaml
- Trigger: Push to non-main branches
- Base: main
- Uses GitHub CLI to create PR with branch name as title
```

**How it works:**
1. When you push to a feature branch, the workflow runs
2. Uses `gh pr create` to create a PR from your branch → `main`
3. PR title is auto-generated as `PR: {branch-name}`
4. Workflow is skipped if pushed directly to `main`

**Note:** If a PR already exists for the branch, the workflow will fail (which is expected behavior - no duplicate PRs).

## Testing

**Current Status:** No testing framework configured yet. Manual testing during development is required.

Future testing strategy (from specs):
- E2E: Playwright for critical flows (login, interview creation, chat)
- Unit: Focus on interview logic; colocate tests with components (`*.test.tsx`)

## Docker Development

### Prerequisites
Start Supabase locally before running Docker:
```bash
supabase start
```

### Development Mode (Hot Reload)
```bash
make docker-dev              # Start dev environment with hot reload
make docker-dev-detached     # Start in background
make docker-down             # Stop containers
make docker-logs             # View logs
```

Uses `Dockerfile.dev` with:
- All dev dependencies installed
- Source code mounted as volumes for instant hot reload
- Panda CSS watcher enabled
- Next.js dev server running
- Connects to host's local Supabase (port 54321)

### Production Mode (Testing)
```bash
make docker-prod             # Build and run production image
make docker-prod-detached    # Run in background
make docker-prod-build       # Build without starting
```

Uses `Dockerfile` (multi-stage build) with optimized standalone output.

### How It Works
- **Next.js:** Runs in Docker container on port 3000
- **Supabase:** Runs on host machine (`supabase start` on port 54321)
- **Browser client:** Uses `localhost:54321` (from .env.local)
- **Server-side code:** Can use `host.docker.internal:54321` if needed
- **Code changes:** Trigger hot reload automatically via volume mounts
- **Source sync:** `src/`, `public/`, config files mounted as volumes for live updates

---

## Deployment & Environments

- **Development:** Local Supabase instance (port 54321)
- **Staging/Production:** Real Supabase projects (update `.env.local` variables)
- **Email:** Currently logs URLs to console; real implementation pending
- **Hosting:** Docker-ready; deploy targets TBD (GCP, Scaleway, Digital Ocean, or EU servers)

## Important Notes

1. **⚠️ Chakra UI v3 ONLY** - v2 components/patterns cause TypeScript errors
   - `InputRightElement` → use `endElement` prop
   - `colorScheme` → use `colorPalette`
   - `spacing` → use `gap`/`columnGap`/`rowGap`
   - If TypeScript says "has no exported member", it's a v2 component
   - Run `make lint` to catch violations before committing

2. **Never edit `styled-system/`** - This directory is auto-generated by Panda CSS

3. **French first** - UI text and messages should be in French by default

4. **Default branch is `main`**

5. **Secrets in `.env.local`** - Never commit environment variables

6. **Parallel dev setup** - `make devrun` runs Panda watch + Next.js server together

7. **Role-based access** - Users have `role` enum: `student`, `teacher`, `admin`

8. **RLS enabled** - All tables use Row-Level Security for data isolation

9. **Path aliases** - Always use `@/` imports (never relative `../../../`)
   - TypeScript will complain if paths don't exist
   - Run `make lint` to verify import paths

## Resources

- **Next.js Docs:** https://nextjs.org/docs
- **Chakra UI v3:** https://chakra-ui.com/
- **Panda CSS Docs:** https://panda-css.com/
- **Supabase Docs:** https://supabase.com/docs
- **TypeScript Handbook:** https://www.typescriptlang.org/docs/
- **Project Specs:** `/docs/specs/specification_stack_and_tools.md`
- **Chakra v3 Migration:** `/docs/chakra-v3/`
- **Development Guidelines:** `/AGENTS.md`
